= Time Exceeded

Time Exceeded (время истекло) - этой группе находится всего 2 вида сообщения:

* *Тип* = 11, *код* = 0 - time to live exceeded in transit (время пересылки истекло).
* *Тип* = 11, *код* = 1 - fragment reassembly time exceeded (время сборки (дефрагментации) пакета истекло)

== Time to live exceeded in transit

В IP протоколе есть поле TTL (Time To Live), размер этого поля 1 байт (8 бит). Каждый раз, когда IP пакет проходит через маршрутизатор, значение этого поля уменьшается на 1. Когда значение поля становится равным 0, пакет отбрасывается. Это такая защита от вечной пересылки пакета по сети Интернет. При наступлении такого события хост отправляет ICMP сообщение время пересылки истекло.

NOTE: Еще это сообщение иногда называют “похоронка”.

.Сеть из одного хоста и 3-х маршрутизаторов генерирует ошибку ICMP TTL exceeded. (https://miminet.ru/web_network?guid=7509b963-d190-4aad-8d90-9be42f302bbb).
image::{docdir}/images/ttl_example.png[Сеть из одного хоста и 3-х маршрутизаторов генерирует ошибку ICMP TTL exceeded. (https://miminet.ru/web_network?guid=7509b963-d190-4aad-8d90-9be42f302bbb).]

Для демонстрации, соберем сеть из 1 хоста и 3-х маршрутизаторов, как показано на рисунке выше. Маршрутизаторы объединены в кольцо, что позволяет IP пакету циркулировать там, пока на это хватит TTL.

С хоста 1 отправим ICMP это запрос на IP адрес 12.34.45.67. При этом, установим его TTL=5 через опцию -t.

Запустив анимацию сети мы увидим, что наш ICMP пакет успевает сделать 1 круг и на маршрутизаторе 2 его TTL становится 0, что приводит к генерации ICMP сообщения time to live exceeded.

Таким образом, хост источника понимает, что в сети где-то появилось кольцо и необходимо вмешательство сетевого администратора.

Кстати говоря, еще это хороший способ узнать, сколько маршрутизаторов между вами и каким-то хостом в Интернете. Для этого можно отправлять ICMP запросы с постоянно увеличивающимся TTL. С TTL=1 вы получите ICMP сообщение от первого маршрутизатора, с TTL=2 от второго и так далее, пока не получите ICMP ответ.

== Fragment reassembly time exceeded

Если размер IP пакета больше, чем текущий MTU (Max Transfer Unit), то такой пакет фрагментируется на несколько более мелких пакетов. Если во время пересылки один или несколько таких фрагментов потеряется, то удаленный хост не сможет собрать IP пакет обратно. Если хост не может собрать обратно IP пакет слишком долго, то он может отправить ICMP сообщение Fragment reassembly time exceeded.

Стоит знать о такой ошибке, хотя лично ее в жизни никогда не встречал.





== Сеть недоступна

Данное сообщение устанавливает *тип* = 3, *код* = 0. Ошибка генерируется, когда хоста или маршрутизатор не знает маршрута до IP сети, в которой находится IP адрес назначения.

.Сеть из двух узлов генерирует ошибку ICMP сеть недоступна. (https://miminet.ru/web_network?guid=6994b921-cc0f-4cbd-b209-7f30784027d7)
image::{docdir}/images/net_unreachable.png[Сеть из двух узлов генерирует ошибку ICMP сеть недоступна. (https://miminet.ru/web_network?guid=6994b921-cc0f-4cbd-b209-7f30784027d7)]

Для примера соберем сеть из 1 хоста и 1 маршрутизатора, как показано на рисунке выше. У хоста в качестве маршрутизатора по умолчанию пропишем маршрутизатор 1. А сам маршрутизатор будет знать только про сеть, к которой сам и подключен - это 192.168.1.0/24.

С хоста 1 попробуем отправить 1000 байт по TCP на IP адрес 8.8.4.4. Как мы уже знаем, для начала TCP попробует установить TCP соединение (SYN, SYN+ACK, ACK). Так как IP адрес назначения не в нашей сети, то хост 1 отправит его на маршрутизатор. Маршрутизатор, получив этот пакет, не сможет отправить его куда-либо дальше, так как у него нет маршрута до IP сети, которой принадлежит IP адрес назначения. Другими словами, в таблице маршрутизации у маршрутизатора нет ни одной подходящей записи для IP адреса 8.8.4.4.

Так как маршрутизатор не знает, куда отправить этот пакет дальше, он его отбрасывает. Чтобы сообщить об этой ошибке отправителю, генерирует и отправляет ICMP сообщение Destination net unreachable.

Кстати, обратите внимание, TCP прекращает попытки установки соединения сразу после получения этого ICMP сообщения. А если бы не это ICMP сообщение, то TCP так бы и пытался дальше устанавливать соединение.

== Хост недоступен

*Тип* = 3, *код* = 1. Ошибка генерируется, когда маршрутизатор не может доставить пакет до хоста с IP адресом назначения.

Соберем сеть из 2-х хостов и 1 маршрутизатора, как на рисунке ниже.

.Сеть из двух узлов генерирует ошибку ICMP хост недоступен. (https://miminet.ru/web_network?guid=1646e111-1a47-4d98-a253-c396904e5351)
image::{docdir}/images/host_unreachable.png[Сеть из двух узлов генерирует ошибку ICMP хост недоступен. (https://miminet.ru/web_network?guid=1646e111-1a47-4d98-a253-c396904e5351)]

Хост 1 пытается подключиться к хосту с IP адресом 172.16.12.22 на порт 5555. Сам хост 1 находится в сети 192.168.1.0/24. Поэтому, TCP пакет отправляется на маршрутизатор 1. Маршрутизатор знает про сеть 172.16.12.0/24, в которой находится IP адрес 172.16.12.22. Он пытается отправить пакет для него и начинает отправлять ARP запросы, в поисках MAC адреса для IP адреса 172.16.12.22.

После 3-х попыток маршрутизатор делает вывод, что хост с IP адресом 172.16.12.22 не отвечает (его нет или он выключен) и генерирует ICMP сообщение Destination host unreachable.

Если запустить анимацию сети, то можно увидеть, как маршрутизатор отправит аж 3 ICMP сообщения о недостижимости хоста. Это все потому, что за время поиска MAC адреса для IP 172.16.12.22 он успел получить целых 3 TCP пакета для этого IP. Поэтому он отправляет 3 ICMP сообщения в ответ на эти три TCP пакета.

Таким образом, маршрутизатор сообщает источнику, что он знает про нужную сеть, но хост либо отсутствует или выключен. В любом случае, не отвечает.

== Протокол недоступен

Никогда не встречал в жизни.

== Порт недоступен
*Тип = 3*, *код* = 3. Ошибка генерируется, когда хост получает UDP датаграмму на порт, который никто не слушает.

Если UDP отправляет датаграмму на порт, который никто не слушает на удаленной стороне, то в ответ он ничего не получит. И как определить, это датаграмма потерялась или на хосте назначения никто не слушает указанный порт?

Для решения этой проблемы используется ICMP сообщение порт недоступен. Это сообщение помогает отправителю UDP сообщений понять, удаленная сторона готова к работе или нет. Это некоторый аналог установки соединения в TCP, только тут ICMP сообщение приходит только в случае недоступности порта.

Соберем сеть из 1 хоста и двух серверов, как показано на рисунке ниже.

.Сеть из одного хоста и двух серверов генерирует ошибку ICMP порт недоступен. (https://miminet.ru/web_network?guid=46fb1ad6-555e-4e61-98eb-e6d66346ae60).
image::{docdir}/images/port_unreachable.png[Сеть из одного хоста и двух серверов генерирует ошибку ICMP порт недоступен. (https://miminet.ru/web_network?guid=46fb1ad6-555e-4e61-98eb-e6d66346ae60).]

Хост 1 отправит два UDP пакета на порт 5555:

* Один на сервер 1 с IP адресом 192.168.1, где порт 5555 будет закрыт.

* Второй на сервер 2 с IP адресом 192.168.1.3, где порт 5555 будет открыт

Запустив такую сеть мы увидим, что сервер 1, получив UDP датаграмму на порт 5555 отправляет в ответ ICMP сообщение Destination port unreachable. А сервер 2, получив UDP датаграмму на порт 5555 ничего не отправляет, так как UDP датаграмма была обработана.

Таким образом, ICMP сообщение Destination port unreachable помогает UDP клиентам определять, действительно ли удаленная сторона готова принимать данные или нет.

== Нужна фрагментация, но стоит флаг DF

*Тип* = 3, *код* = 4. ICMP сообщение генерируется в случае, когда IP протоколу нужно провести дефрагментацию пакета, но в опциях IP протокола установлен флаг DF (Don’t fragment) запрещающий проводить фрагментацию.

В обычной жизни такая ошибка возникает довольно редко. Для примера возьмем сеть из 2-х хостов и одного маршрутизатора, как показано на рисунке ниже. Между хостом 1 и маршрутизатором MTU будет 9000. Напомню, что MTU - это Maximum Transfer Unit, максимальный размер пакета, который можно передать в сеть. Обычно MTU равен 1500, но есть стандарты, которые позволяют передавать Jumbo-фреймы (слоновые фреймы), размер которых может достигать до 9000 байт.

.Сеть из двух хостов и одного маршрутизатора генерирует ошибку ICMP нужна фрагментация, но стоит флаг DF.
image::{docdir}/images/icmp_df.png[Сеть из двух хостов и одного маршрутизатора генерирует ошибку ICMP нужна фрагментация, но стоит флаг DF.]

Пусть хост 1 отправит данные размером в 9000 байт на хост 2, при этом установит в IP пакете флаг DF (Don’t fragment). Маршрутизатор получит такой пакет и попробует его отправить на хост 2. Так как пакет размером 9000 байт, а MTU между хостом 2 и маршрутизатором всего 1500, то такой пакет нужно фрагментировать и отправлять порциями. Но флаг DF в IP пакете запрещает фрагментацию.

Как результат, маршрутизатор не сможет отправить такой пакет дальше, выбросит его, сгенерировав ICMP сообщение "Нужна фрагментация, но стоит флаг DF" и отправит его на хост 1.

Таким образом, хост 1 поймет, что пакет был отброшен.

Это ошибку можно посмотреть самостоятельно на своем локальном компьютере. Если у вас Windows, в командной консоли выполните команду

 ping -l 2000 -f 77.88.8.8

Результат работы команды показан на рисунке ниже. Флаг l - устанавливает размер пакета, в нашем случае это 2000 байт, а флаг f запрещает фрагментировать пакеты.

.Утилита ping получает ICMP сообщение нужна фрагментация, но стоит флаг DF.
image::{docdir}/images/icmp_df_windows.png[Утилита ping получает ICMP сообщение нужна фрагментация, но стоит флаг DF.]

На сетевом уровне IP протокол понимает, что пакет необходимо фрагментировать, но стоит запрещающий флаг. Поэтому такой пакет отбрасывается и генерируется соответствующее ICMP сообщение.

== Маршрут от источника недоступен

IP протокол поддерживает опциональные заголовки и для этого у него есть отдельное поле опции (Options). Если забыли формат протокола IP, можете подсмотреть в https://www.rfc-editor.org/rfc/rfc791#page-11[RFC 791].

Одной из таких опций является маршрутизация от источника (*source routing*). Эта опция позволяет отправителю указать маршрутизатор или несколько маршрутизаторов, через которые данный пакет должен пройти. Соответственно, при невозможности отправки пакета по тому пути, который прописан в опции source routing вызывает ICMP сообщение о том, что маршрут от источника недоступен.

Стоит сказать, что почти все современные ОС и маршрутизаторы отключают ту опцию. Так как это небезопасно.
