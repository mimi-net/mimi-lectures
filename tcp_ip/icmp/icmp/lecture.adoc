= ICMP

Во время передачи данных в сети могут возникать ошибки. И эти ошибки могут быть спонтанными и постоянными. Следствием таких ошибок, обычно, является потеря пакета. Пример спонтанной ошибки - помехи во время передачи сигнала или переполнение буфера на прием пакетов у маршрутизатора. Если хост повторно отправит пакет, то со второго раза он скорее всего дойдет до конечного адресата.

А есть постоянные ошибки, которые часто связаны с неверной настройкой сети. Например, во время пересылки пакета через маршрутизатор у пакета закончился TTL (стал равен 0) и маршрутизатор выбрасывает такой пакет. Сколько бы раз TCP не пытался восстановить потерянный пакет, у него ничего не получиться. Ведь каждый раз пакет будет проходить через тот-же маршрутизатор и отбрасываться.

Как итог, пользователь или программист решит, что проблема на сервере, так как не смог к нему подключиться. Но на самом деле, проблема в невозможности доставить пакет между этими двумя хостами.

ICMP (Internet Control Message Protocol) - протокол помогает определить ошибки на сетевом и транспортном  уровне. ICMP протокол описан в RFC 792 и является неотъемлемой частью TCP/IP стека.

ICMP работает поверх IP протокола, но при этом является протоколом сетевого уровня, как показано на рисунке ниже. Его относят к сетевому уровню, так как он по большей части решает проблемы на сетевом уровне.

.ICMP протокол в модели ISO/OSI.
image::{docdir}/images/icmp_osi.png[ICMP протокол в модели ISO/OSI.]

На рисунке 127 изображен формат заголовка ICMP. Как видно, ICMP заголовок занимает всего 16 байт.

.Формат ICMP протокола. (https://www.rfc-editor.org/rfc/rfc792#page-4)
image::{docdir}/images/icmp_header.png[Формат ICMP протокола. (https://www.rfc-editor.org/rfc/rfc792#page-4)]

Основными полями в ICMP протоколе являются тип (Type) и код (Code):

* Поле тип (*Type*) - указывает на тип возникшей проблемы, например, пункт назначения недостижим (Destination unreachable)

* Поле код (*Code*) - конкретизирует ошибку, например, если тип указывает на Destination unreachable, то код конкретизирует: сеть недоступна, хост недоступен или порт недоступен.

* Поле контрольной суммы (@Checksum@) - CRC16

* Следующие 16 бит зарезервированы (*unused*) для различных типов и кодов ICMP сообщений. Некоторым ICMP сообщениям нужно там размещать дополнительные поля, а некоторым нет.

* Заголовок *IP + 64 бита данных* - в этом поле содержиться тот самый пакет, который вызвал ошибку. Таким образом, получив ICMP сообщение хост сможет понять, какой именно пакет вызвал ошибку.

Если на хосте или маршрутизаторе во время обработки пакета возникает определенный тип ошибки, то он формирует определенное ICMP сообщение, в него вкладывается IP пакет, который вызвал эту ошибку и это сообщение отправляется на IP адрес отправителя проблемного IP пакета. Таким образом ICMP сообщает отправителю, об ошибке.
