= Redirect

Сообщение ICMP Redirect (перенаправление) рекомендует хосту внести изменения в свою таблицу маршрутизации.

*Тип* = 5

Основные коды:

* *0* - перенаправление для сети
* *1* - перенаправление для хоста

Есть еще код 2 и 3, но я не видел их применения в жизни. Не уверен, что они по-прежнему используются. Если очень интересно, предлагаю почитать https://datatracker.ietf.org/doc/html/rfc792[RFC 792] и исходники ядра Linux.

Для примера, сделаем сеть как показано на рисунке ниже.  Нам понадобиться 2 хоста, 1 маршрутизатор и 1 свитч или хаб.

Все устройства подключены к одному свичу, что делает возможным обмениваться данными напрямую. А вот IP настройки таковы, что хост 1 (10.0.0.1/24) и хост 2 (192.168.1.1/24) находяться в разных IP сетях. Поэтому, если мы попробуем отправить пакет от хоста 1 к хосту 2, то мы не сможем это сделать, так как у хоста 1 в таблице маршрутизации нет подходящей записи.

.Сеть из двух хостов и одного маршрутизатора генерирует сообщение ICMP Redirect. (https://miminet.ru/web_network?guid=1d4704c2-f8db-436c-8da9-2892e4d0f577)
image::{docdir}/images/redirect_miminet.png[Сеть из двух хостов и одного маршрутизатора генерирует сообщение ICMP Redirect. (https://miminet.ru/web_network?guid=1d4704c2-f8db-436c-8da9-2892e4d0f577).]

Чтобы хосты могли обмениваться данными между собой. Нам нужно либо добавить запись в их таблицу маршрутизации или добавить в сеть маршрутизатор. Добавим в сеть маршрутизатор и на одном интерфейсе настроим 2 IP адреса:

. 10.0.0.100/24
. 192.168.1.100/24

Один IP адрес будет из сети хоста 1, второй, из сети хоста 2. Таким образом, маршрутизатор будет находиться в двух сетях одновременно и сможет переправлять пакеты от одного хоста к другому.

На хостах выполним 3 команды:

* На хосте 1 выполним ping на хост 2
* На хосте 2 выполним ping на хост 1
* И снова на хосте 1 выполним ping на хост 2

А теперь рассмотрим, что произойдет. И для начала, давайте опустим ARP запросы из объяснения и так понятно зачем они нужны:

. Хост 1 отправляет ICMP запрос для хост 2 на маршрутизатор.
. Маршрутизатор, получив ICMP запрос от хоста 1 отправляет его на хост 2. И вот тут происходит интересное. Маршрутизатор отправляет полученные ICMP запрос в тот же сетевой интерфейс, откуда он его только что получил. Это означает, что маршрутизатор в этой цепочке доставки пакета лишний и хост 1 может напрямую доставлять пакеты до хоста 2.
. Маршрутизатор, через сообщение ICMP redirect рекомендует хосту 1 поправить свою таблицу маршрутизации таким образом, чтобы он доставлял пакеты для хоста 2 напрямую, минуя маршрутизатор.
. Такая же ситуация происходит и в ситуации, когда хост 2 отправляет хосту 1 ICMP ответ. Маршрутизатор отправляет хосту 2 ICMP redirect о том, что он может отправлять пакеты для хоста 1 напрямую.

Как итог, можно увидеть, что когда хоста 1 уже во второй раз выполняет команду ping на хост 2, то пакеты между ними ходят напрямую, минуя маршрутизатор. Таким образом, ICMP redirect позволяет сокращать маршруты доставки пакетов.

Стоит обратить внимание, что ICMP redirect очень небезопасен, при этом, они по умолчанию обрабатываются многими ОС. Поэтому, сетевые администраторы настраивают свои фаерволы таким образом, чтобы они блокировали эти пакеты или вносят изменения в настройки ОС.

Для ОС Linux настройки ICMP redirect можно посмотреть в sysctl, как показано на рисунке ниже.

.Настройка ICMP redirect в ОС Linux.
image::{docdir}/images/linux_sysctl.png[Настройка ICMP redirect в ОС Linux.]

Под Windows настройка поведения при получении ICMP redirect находится в ветке реестра

 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters.