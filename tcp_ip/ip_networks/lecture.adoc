= Отправка пакета в другой сегмент сети

Давайте рассмотрим ситуацию, как показано на рисунке ниже. У нас есть сеть из 3-х хостов, два их которых находятся в одном сегменте сети, а третий хост в другом. Оба сегмента сети соединяет маршрутизатор.

.Хосты в разных сегментах сети. (https://miminet.ru/web_network?guid=8682ffde-135e-4e16-acd5-030d24dc4d59)
image::{docdir}/images/2_segments.png[Хосты в разных сегментах сети. (https://miminet.ru/web_network?guid=8682ffde-135e-4e16-acd5-030d24dc4d59).]

Если хост 1 c IP адресом 10.0.0.1 захочет отправить пакет хосту 2 с IP адресом 10.0.0.2, то:

* хост 1 проверит, есть ли хост 2 в ARP-кэше
* если нет, то отправит в сеть ARP-запрос
* подождет ARP-ответ от хоста 2
* отправит желаемый пакет хосту 2

Это мы уже знаем. А еще мы говорили, что сетевой уровень и IP протокол в частности должен уметь доставлять пакеты от одного хоста к другому даже если хост назначения находится в другой сети. Если хост 1 захочет отправить пакет хосту 3 с IP адресом 172.16.0.3, что он должен сделать?

Глядя на схему не сложно догадаться, что хост 1 должен отправить пакет на маршрутизатор А, а тот в свою очередь отправит пакет на хост 3. Но хост 1 не видит этой схемы, у него нет информации о топологии сети и настройках всех хостов. Как он должен догадаться, что в этом случае он должен отправлять пакет на маршрутизатор А?

Для решения этой проблемы давайте заведем на хостах еще одну таблицу и назовем ее “Таблица маршрутизации”. Эта таблица будет состоять из 2-х полей:

* IP адрес назначения
* IP адрес маршрутизатора

Если IP адрес назначения находится в нашем сегменте сети, то в качестве IP адреса маршрутизатора будем выступать мы сами. А если IP адрес назначения будет находиться в другой сети, то IP адрес маршрутизатора будет IP адрес маршрутизатор.

Обновим нашу схему, как показано на рисунке ниже. Добавим 2 IP адреса для маршрутизатора А. Один для связи с одним сегментом сети, второй для связи со вторым сегментом сети. Т.е. IP 10.0.0.100 для связи с хостом 1 и хостом 2, а 172.16.0.100 для связи с хостом 3.

.Хосты в разных сегментах сети.(https://miminet.ru/web_network?guid=f536f79f-e533-4905-abcc-1846a8a407fb)
image::{docdir}/images/2_segments2.png[Хосты в разных сегментах сети. (https://miminet.ru/web_network?guid=f536f79f-e533-4905-abcc-1846a8a407fb).]

Тогда таблица маршрутизации для хоста 1 будет выглядеть как на таблице.

[cols="1,1"]
|===
^|IP адрес назначения
^|IP адрес маршрутизатора

^|10.0.0.2
^|10.0.0.1

^|172.16.0.3
^|10.0.0.100

^|10.0.0.100
^|10.0.0.1
|===

Каждый раз, когда хост 1 будет отправлять пакет, он будет заглядывать в таблицу вмаршрутизации.

Если хост 1 захочет отправить пакет хосту 2 (чей IP 10.0.0.2), то:

* хост 1 ищет в таблице маршрутизации IP адрес 10.0.0.2. Этому адресу соответствует IP адрес маршрутизатора 10.0.0.1
* та как IP адрес маршрутизатора совпадает с IP адресом самого хоста, значит он сам знает как доставить пакет по адресу 10.0.0.2 и передает этот пакет на канальный уровень
* а дальше мы уже знаем: смотрим ARP-кэш, ARP-запрос, ARP-ответ и отправка пакета.

А если хост 1 хочет  отправить пакет хосту 3 с IP адресом 172.16.0.3, то:

* хост 1 ищет в таблице маршрутизации IP адрес 172.16.0.3. Этому адресу соответствует IP адрес маршрутизатора 10.0.0.100
* IP адрес маршрутизатора не совпадает с IP адресом хоста, значит, нужно отправить пакет маршрутизатору с IP адреса 10.0.0.100 и пусть он дальше доставляет пакет
* передаем пакет на канальный уровень с указанием, что MAC адрес назначения будет MAC адрес хоста с IP адресом 10.0.0.100 (это маршрутзатор). Очень важный момент, хоть IP адрес назначения в данном случае 172.16.0.3, но на канальном уровне мы доставляем пакет на маршрутизатор, как показано на рисунке ниже.

.Доставка пакета на сетевом уровне на хост 3, но на канальном уровне на маршрутизатор А.
image::{docdir}/images/arp2router.png[Доставка пакета на сетевом уровне на хост 3, но на канальном уровне на маршрутизатор А.]

* и теперь начинается знакомый нам процесс, хост 1 смотрит в ARP-кэш в поисках MAC адреса для IP 10.0.0.100 (router_A).
* если его там нет, то отправляет ARP-запрос, после получения ARP-ответа отправляет пакет в сеть
* маршрутизатор А получив пакет смотрит уже в свою таблицу маршрутизации и так же как и хост 1 пытается понять куда дальше отправлять пакет.

Таким образом, используя таблицу маршрутизации хост может понять, как отправлять пакет - самому или на маршрутизатор.

Важно запомнить, что таблица маршрутизации находится на каждом хосте, который подключен к сети Интернет. А не только на маршрутизаторе. Без таблицы маршрутизации хост не поймет, когда он может сам доставить пакет, а когда нужно передать его на маршрутизатор.

== IP сети

Давайте добавим в наш пример еще несколько хостов, как на рисунке ниже.

.Сеть из 5 хостов, 2-х свитчей и 1 маршрутизатора. (https://miminet.ru/web_network?guid=7714de3c-1b74-4e3e-a33e-665662d71713).
image::{docdir}/images/5_hosts.png["Сеть из 5 хостов, 2х свитчей и 1 маршрутизатора. (https://miminet.ru/web_network?guid=7714de3c-1b74-4e3e-a33e-665662d71713)."]

Получается, что для такой сети таблица маршрутизации на хосте 1 должна стать как в таблице ниже

[cols="1,1"]
|===
^|IP адрес назначения
^|IP адрес маршрутизатора

^|10.0.0.2
^|10.0.0.1

^|10.0.0.5
^|10.0.0.1

^|10.0.0.100
^|10.0.0.1

^|172.16.0.3
^|10.0.0.100

^|172.16.0.4
^|10.0.0.100
|===

Т.е. мы добавили в сеть два хоста и теперь хост 1 должен о них как-то узнать и добавить их в свою таблицу маршрутизации. А если мы добавим еще 100 хостов, что тогда? Владельцы всех хостов должны как-то обмениваться информацией о том, кто и куда подключен и своим IP адресом?!

Описанный выше способ доставки пакетов из одной сети в другую хоть и рабочий, но не эффективный. Большую сеть так не построить. Для решения этой проблемы предлагается ввести понятие IP сеть. IP сеть - это множество IP адресов. Очень важно обратить внимание, что множество IP адресов, а не хостов.

== Классовая адресация сетей

Исторически, весь диапазон IP адресов (т.е все 4 байта) разбили на 5 классов сетей (A, B, C, D, E). Это означало, что одна часть IP адреса теперь указывает на класс сети, а остальная часть идентифицирует хост.

*Сети класса А* лежат в диапазоне от 0.0.0.0 до 127.255.255.255. Для идентификатора сети используется 1 байт, а остальные 3 байта для идентификации хоста.

.Сеть класса А.
image::{docdir}/images/class_a.png[Сеть класса А.]

В одной сети класса А может находиться до 16 777 215 (256 * 256 * 256) хостов. Правда, таких сетей не много, всего 128. Вот пример некоторых сетей класса А:

* 8.0.0.0	- 8.255.255.255
* 10.0.0.0 - 10.255.255.255
* 104.0.0.0 - 104.255.255.255

*Сети класса B* лежат в диапазоне от 128.0.0.0 до 191.255.255.255. Для идентификатора сети используется первые два байта, а остальные 2 байта для идентификации хоста.

.Сеть класса B.
image::{docdir}/images/class_b.png[Сеть класса B.]

В одной сети класса B может находиться до 65 535 (256 * 256) хостов. Вот пример некоторых сетей класса B:

* 169.254.0.0 - 169.254.255.255
* 172.16.0.0 - 172.16.255.255
* 190.56.0.0 - 190.56.255.255

*Сети класса C* лежат в диапазоне от 192.0.0.0 до 223.255.255.255. Для идентификатора сети используется первые 3 байта, а оставшийся бай для идентификации хоста.

.Сеть класса C.
image::{docdir}/images/class_c.png[Сеть класса C.]

В одной сети класса C может находиться всего 255 хостов. Вот пример некоторых сетей класса С:

* 192.168.1.0 - 192.168.1.255
* 204.16.6.0 - 204.16.6.255
* 220.215.65.0 - 220.215.65.255
