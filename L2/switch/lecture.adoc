= Коммутатор (свитч)

Для решения проблемы с масштабируемостью и производительностью сети был предложен свитч.

Свитч (он же коммутатор) - активное сетевое оборудование, которое работает на втором уровне модели ISO/OSI. Т.е он уже может работать с Ethernet кадрами. Выглядит свитч так же как и хаб, небольшая коробка с портами.

.Свитч.
image::{docdir}/images/switch.png[Свитч.]

Свитч - это поумневший хаб. Он пытается отправлять Ethernet пакеты в тот порт, куда подключен хост назначения.

Для примера снова будем использовать сеть из трех хостов, только сеть будет построена через свитч, как на рисунке ниже. Также, допустим, что хост 1 (host_1) подключен в порт 1 на свитче, хост 2 в порт 2, а хост 3 в порт 3.

.Сеть из 3-х хостов со свитчем. (https://miminet.ru/web_network?guid=6cfb1dc5-9c80-4083-a87b-ff96a51ad0bd).
image::{docdir}/images/switch_example.png[Сеть из 3-х хостов со свитчем. (https://miminet.ru/web_network?guid=6cfb1dc5-9c80-4083-a87b-ff96a51ad0bd)]

На канальном уровне все хосты используют MAC адрес (он же физический адрес). И он должен быть уникальный в рамках одного сегмента сети. Если вдруг в сети будет два хоста с одинаковым MAC адресом, то мы не можем однозначно сказать, какому хосту предназначаются данные. Допустим, в нашей сети хосты имеют следующие MAC адреса:

* host_1 -> 00:00:00:00:00:01
* host_2 -> 00:00:00:00:00:02
* host_3 -> 00:00:00:00:00:03

Во время работы, свитч запоминает MAC адреса отправителей в специальной таблице под названием таблица коммутации. Обратите внимание, свитч не запоминает MAC адреса получателя, только отправителя.

[cols="1,1"]
|===
^|MAC адрес
^|Порт
|===

Таблица коммутации состоит из двух колонок:

* MAC адрес
* Номер порта, к которому подключен хост с данным MAC адресом.

== Алгоритм работы свитча

Пусть в нашем случае, хост 1 отправит пакет хосту 2. Алгоритм работы свитча следующий:

. Изначально, как только свитч включают, его таблица коммутации пустая.
. Когда на свитч приходит пакет, он записывает в таблицу MAC адрес отправителя и номер порта, который принял этот кадр из сети. Т.е в нашем случае на порт 1 приходит Ethernet кадр с MAC адресом отправителя 00:00:00:00:00:01 и в таблицу коммутации добавляется запись:

+
--
[cols="1,1"]
|===
^|MAC адрес
^|Порт

^|00:00:00:00:00:01
^|1
|===
--
+

. Дальше свитч пытается отправить пакет в тот порт, куда подключен получатель. Для этого он достает из Ethernet пакета MAC адрес получателя (00:00:00:00:00:02) и ищет его в своей таблице коммутации. В нашем случае, такого адреса в таблице коммутации нет. В этом случае свитч работает как хаб, отправляет пакет во все остальные подключенные порты. Т.е. в порт 2 и 3.

А теперь, пусть хост 2 отправит пакет хосту 1:

. Когда на свитч придет пакет от хоста 2, он добавит запись в свою таблицу коммутации:
+
--
[cols="1,1"]
|===
^|MAC адрес
^|Порт

^|00:00:00:00:00:01
^|1

^|00:00:00:00:00:02
^|2
|===
--
+

. Свитч снова пытается отправить пакет в тот порт, куда подключен получатель. В нашем случае, MAC адрес получателя будет 00:00:00:00:00:01. Свитч ищет его в таблице коммутации и находит. Запись гласит, что хост с MAC адресом 00:00:00:00:00:01 подключен к первому порте. Именно туда свитч и отправит пакет.

Как не сложно догадаться, если хост 1 отправит пакет хосту 3, то свитч отправит этот пакет в порт 2 и 3. Так как информации про MAC адрес 00:00:00:00:00:03 в таблице коммутации нет.

== Режим работы коммутатора

Коммутаторы могут работать в двух режимах:

* Store-and-Forward - комммутатор помещает полученный кадр в буфер перед обработкой.
* Cut-through - коммутатор проводит обработку пакета налету.

== Часто задаваемые вопросы

*Вопрос 1*: Может ли в таблице коммутации на одном порте быть несколько MAC адресов?

*Ответ*: Да, конечно. Например, если в порт свитча мы подключили другой свитч или хаб с несколькими хостами, как показано на рисунке. В этом случае, на порте свитча, куда подключен хаб, может быть записаны MAC адреса хоста 2 и хоста 3.

.В свитч подключен хаб (https://miminet.ru/web_network?guid=d5eb566d-402e-442f-a98a-d5341568a5c9).
image::{docdir}/images/qa1.png[В свитч подключен хаб (https://miminet.ru/web_network?guid=d5eb566d-402e-442f-a98a-d5341568a5c9)]

*Вопрос 2*: Допустим наша текущая таблица коммутации как показано в таблице 5. И свитч получает на порт 2 пакет, где MAC адрес отправителя такой же - 00:00:00:00:00:01. Как поведет себя свитч в данной ситуации?

[cols="1,1"]
|===
^|MAC адрес
^|Порт

^|00:00:00:00:00:01
^|1
|===

*Ответ*: Как мы говорили раннее, в одном сегменте сети MAC адреса должны быть уникальными. С этой позиции исходит и свитч. Если он получает пакет на порт и выясняется, что MAC адрес отправителя этого пакета уже есть в таблице коммутации, но на другом порте, то такая запись удаляется. А вместо нее свитч добавляет новую, с текущим портом. Т.е. таблица коммутации будет выглядеть как в таблице ниже.

[cols="1,1"]
|===
^|MAC адрес
^|Порт

^|00:00:00:00:00:01
^|2
|===

*Вопрос 3*: Если какой-нибудь хост в сети будет отправлять пакеты с таким MAC адресом получателя, которого нет в сети, то свитч всегда будет его отправлять по всем портам, как хаб?

*Ответ*: Да, это так. И администраторы сети не любят таких пользователей.

*Вопрос 4*: Что произойдет, если в сети будет 2 хоста с одинаковыми MAC адресами?

*Ответ*: В этом случае, по мере того, как хосты с одинаковыми MAC адресами будут отправлять пакеты в сети, свитч будет переписывать MAC адрес то для одного, то для другого порта. Это приведет к тому, что часть пакетов, которые будет предназначаться для этого MAC адреса будет приходить для одного хоста. А другая часть пакетов придет второму хосту.

*Вопрос 5*: Что будет, если свитчи или хабы замкнуть в кольцо?

*Ответ*: Ethernet не любит кольца. Если сеть будет состоять из хабов, то каждый новый пакет будет бесконечно передаваться от одного хаба к другому, как показано на рисунке. И очень быстро все каналы передачи данных будут полностью загружены, что приведет к невозможности отправлять новые пакеты в сеть. Даже если будут использованы свитчи.

.Кольцо в Ethernet. (https://miminet.ru/web_network?guid=c81180f8-1c01-484e-bed0-05ea09da3f90).
image::{docdir}/images/qa5.png[Кольцо в Ethernet. (https://miminet.ru/web_network?guid=c81180f8-1c01-484e-bed0-05ea09da3f90)]

== Домен коллизии у свитча

Свитч работает на втором уровне модели OSI и может обрабатывать не просто голый сигнал, а целый Ethernet пакет. Для обработки этот пакет необходимо хранить во внутренней памяти свитча.

Обладая оперативной памятью свитч имеет буферы для отправки пакетов. Если на два разных порт, например на порт 1 и 2 одновременно поступят пакеты. То это не вызовет коллизию, как в случае с хабом. Свитч положит эти пакеты к себе в оперативную память, потом решит, в какой порт их необходимо отправить и разместит их в буфере не отправку.

Свитч ограничивает домен коллизий до хоста и порта, к которому тот подключен. На рисунке изображены 3 домена коллизий.

.Домен коллизий при свитче (https://miminet.ru/web_network?guid=d5eb566d-402e-442f-a98a-d5341568a5c9).
image::{docdir}/images/switch_collision_domain.png[Домен коллизий при свитче (https://miminet.ru/web_network?guid=d5eb566d-402e-442f-a98a-d5341568a5c9)]

Если соединения от хоста 1 и хоста 4 полнодуплексные (full-duplex), то там доменов коллизий и вовсе нет. Как мы помним, коллизии могут существовать только в полудуплексных (half-duplex) соединениях.

== Свитч у вас дома

У многих из вас дома или на работе установлен Wi-Fi роутер, похожий на тот, что изображен на рисунке. Посмотрите на него внимательно. Порты для подключения по проводу работают как у коммутатора. Порты коммутатора на рисунке обозначены желтым цветом.

Синий порт - это порт роутера (WAN).

.Wi-Fi роутер.
image::{docdir}/images/switch_at_home.jpeg[Wi-Fi роутер]

== Масштабируемость технологии канального уровня

Свитч действительно решил ряд проблем с масштабируемостью в Ethernet - избавился  от коллизий и оптимизировал передачу пакетов. На сколько большую сеть можно построить теперь?

В начале 2000-х годов в России были популярны домашние сети. Когда группа энтузиастов устанавливала где-то в квартире сетевое оборудование и объединяли свои компьютеры в сеть. А затем уже предлагали жителям дома подключиться к их домашней сети. Таким образом, появлялись домашние сети.

Как показала практика, даже использование свитчей не позволяло строить слишком большие сегменты сети. Примерно 100 хостов. Главной проблемой становились широковещательные пакеты. Время от времени, по разным причинам хост отправляет в сеть широковещательные пакеты, которые должны быть доставлены всем хостам в сети. Когда у вас 30-40 хостов, это терпимо. Но, когда хостов становится 100+, производительность сети начинает страдать.

С другой стороны, мир не ограничен технологией проводного Ethernet. Есть разные стандарты проводного Ethernet (IEEE 802.3 - https://ru.wikipedia.org/wiki/IEEE_802.3), беспроводной Ethernet (802.11), подключение по телефонной линии с использованием модема, а еще есть 3G, LTE и многие другие способы организации обмена данными между хостами. Как быть в этом случае?

Оказывается, вместо того, чтобы стремиться создавать один большой сегмент сети, намного проще создавать небольшие сегменты сети и объединять их. Хороший пример - это ваша домашняя сеть. С одной стороны домашние устройства, подключенные по Wi-Fi, с другой, со стороны провайдера - провод. Это два разных сегмента сети.

.Объединение сегментов сети.
image::{docdir}/images/2_segments.png[Объединение сегментов сети.]